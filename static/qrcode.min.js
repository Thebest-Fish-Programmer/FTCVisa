/* qrcode.min.js â€” tiny loader
   This script loads a QR-code generation library from CDN and exposes
   the global `QRCode` or `QRCode.toCanvas(...)` API.
   It keeps the filename `qrcode.min.js` so your HTML can include it locally.
*/
(function () {
    if (window.QRCode && (window.QRCode.toCanvas || window.QRCode.toDataURL)) {
        // already present
        return;
    }

    // Try jsDelivr bundle for "qrcode" (npm package "qrcode")
    var CDN = 'https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js';

    function loadScript(src, cb) {
        var s = document.createElement('script');
        s.src = src;
        s.async = true;
        s.onload = function () { cb(null); };
        s.onerror = function (e) { cb(e || new Error('failed to load ' + src)); };
        document.head.appendChild(s);
    }

    loadScript(CDN, function (err) {
        if (err) {
            console.error('Failed to load QR library from CDN:', err);
            // As a last resort, create a minimal stub to avoid runtime errors.
            window.QRCode = window.QRCode || {
                toCanvas: function (canvas, _text, _opts, cb) {
                    // Simple fallback: write plain text on canvas
                    try {
                        var ctx = (canvas.getContext && canvas.getContext('2d')) || null;
                        if (!ctx) throw new Error('no canvas context');
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.font = '12px sans-serif';
                        ctx.fillText(typeof _text === 'string' ? _text : JSON.stringify(_text), 10, 20);
                        if (cb) cb(null);
                        return Promise.resolve();
                    } catch (e) {
                        if (cb) cb(e);
                        return Promise.reject(e);
                    }
                },
                toDataURL: function (_text) {
                    // Not implemented fallback
                    return Promise.reject(new Error('QRCode library not loaded'));
                }
            };
        } else {
            console.log('qrcode library loaded from CDN');
        }
    });
})();
